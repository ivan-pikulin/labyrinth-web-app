# Labyrinth - Полные правила игры

## Обзор

**Labyrinth** — это пошаговая roguelike-игра, где игрок исследует трёхмерный лабиринт, сражается с монстрами, собирает предметы и ищет выход. Цель — найти Золото и выбраться через Выход.

---

## 1. Генерация мира

### 1.1 Структура лабиринта

Лабиринт представляет собой **трёхмерную сетку** из ячеек:

| Параметр | Диапазон | По умолчанию |
|----------|----------|--------------|
| Ширина | 3–8 клеток | Случайно |
| Высота | 3–8 клеток | Случайно |
| Этажей | 1–3 уровня | Случайно |

### 1.2 Типы стен и маршрутов

Каждая ячейка имеет **4 направления** (вверх, вправо, вниз, влево), каждое из которых может быть:

| Тип | Описание | Разрушаемость |
|-----|----------|---------------|
| `space` | Открытый проход | — |
| `wall` | Обычная стена | Разрушается бомбой |
| `outer_wall` | Внешняя стена лабиринта | **Неразрушима** |
| `exit` | Выход из лабиринта | **Неразрушим** |

**Важно:** Стены являются **двусторонними** — стена между клетками A и B существует в обеих клетках одновременно.

### 1.3 Размещение объектов

**Здания** (Арсенал, Госпиталь, Портал, Мины, Лифт, Кладбище) занимают клетку **полностью** — на одной клетке может быть только одно здание.

**Сущности и предметы** (Золото, Дракон, Лучник, Сумка, Кольцо Дракона) могут находиться на одной клетке друг с другом и с любым зданием.

**Примеры допустимых комбинаций:**
- Клетка с Арсеналом + Дракон + Золото ✓
- Клетка с Госпиталем + Лучник ✓
- Клетка с Порталом + Мины ✗ (два здания)

### 1.4 Выход

- Во всём лабиринте существует **ровно один Выход** (на одном из этажей)
- Позиция выхода генерируется случайно
- Выход нельзя разрушить бомбой или застроить цементом

---

## 2. Начальные параметры игрока

| Параметр | Значение | Максимум |
|----------|----------|----------|
| Здоровье | 5 HP | 5 HP (увеличивается DragonRing) |
| Стрелы | 5 | 5 |
| Бомбы | 2 | 2 |
| Слоты инвентаря | 1 | Увеличивается сумками (Bag) |

---

## 3. Действия игрока

Игра **пошаговая**: каждый ход игрок выбирает одно действие, после чего монстры автоматически атакуют.

### 3.1 GO (Идти)

Перемещение на одну клетку в выбранном направлении.

**Ограничения:**
- Нельзя пройти сквозь стену
- Нельзя выйти за пределы лабиринта

**При входе на клетку (в фазе свойств клетки) автоматически срабатывают:**
1. Эффекты зданий (Мины, Госпиталь, Арсенал, Портал, Лифт)
2. Подбор предметов (Золото, Сумки, Кольцо Дракона)

**Монстры атакуют отдельно** — в фазе монстров (после фазы свойств клетки).

**Особые случаи:**
- Вход на Выход **без Золота**: ничего не происходит, игрок остаётся на клетке
- Вход на Выход **с Золотом**: **ПОБЕДА**, игра завершается

### 3.2 SHOOT (Стрелять)

Выстрел стрелой в выбранном направлении.

**Механика:**
- Расходует **1 стрелу**
- Стрела летит по прямой, пока не встретит препятствие
- При попадании в стену — стрела исчезает
- При попадании в монстра — наносит урон и исчезает
- Стрела поражает только **первого** монстра на пути

**Урон:**
| Оружие | Урон за попадание |
|--------|-------------------|
| Обычный выстрел | 1 HP |
| С DoubleGun | 2 HP |

**Если стрелы закончились:** действие недоступно, выводится сообщение.

### 3.3 BOMB (Бомба)

Использование бомбы для разрушения стены.

**Механика:**
- Расходует **1 бомбу**
- Дальность: **1 клетка** в выбранном направлении
- Разрушает стену между текущей клеткой и соседней

**Результат по типу препятствия:**

| Цель | Эффект |
|------|--------|
| Обычная стена (`wall`) | Разрушена, становится проходом |
| Внешняя стена (`outer_wall`) | Никакого эффекта |
| Выход (`exit`) | Никакого эффекта |
| Проход (`space`) | Никакого эффекта |

**Если бомбы закончились:** действие недоступно.

### 3.4 BUILD (Строить)

Строительство стены с помощью Цемента.

**Требования:**
- В инвентаре должен быть предмет **Cement**

**Ограничения:**
- Можно строить только там, где сейчас **проход** (`space`)
- **Нельзя** застроить направление с Выходом

**Результат:** создаётся стена в выбранном направлении.

---

## 4. Предметы

### 4.1 Обычные предметы (автоподбор)

При входе на клетку с этими предметами они **автоматически подбираются**:

#### Gold (Золото)
- **Количество в игре:** 1
- **Расположение:** случайная клетка лабиринта
- **Эффект:** необходимо для победы
- **Особенность:** **никогда не теряется** при получении урона

#### DragonRing (Кольцо Дракона)
- **Источник:** падает с убитого Дракона
- **Эффект:**
  - +1 к максимальному здоровью
  - +1 к текущему здоровью
- **Тип:** постоянный бонус (не занимает слот)

#### Bag (Сумка)
- **Источник:** падает с убитого Лучника
- **Эффект:** +1 слот инвентаря для арсенальных предметов
- **Тип:** постоянный бонус (не занимает слот)
- **Накопление:** эффекты нескольких сумок **суммируются** (2 сумки = +2 слота)

### 4.2 Арсенальные предметы

Эти предметы **не подбираются автоматически** — их нужно выбрать в здании Арсенала через кнопки интерфейса.

**Доступные предметы в Арсенале:**

#### Armor (Броня)
- **Эффект:** блокирует **один** источник урона полностью
- **Механика:**
  - При получении урона броня поглощает его
  - После срабатывания броня **уничтожается** и возвращается в Арсенал
- **Лимит:** можно носить только если есть свободный слот

#### DoubleGun (Двойное оружие)
- **Эффект:** удваивает урон стрел (1 → 2 HP за выстрел)
- **Механика:** пассивный бонус, пока предмет в инвентаре
- **Потеря:** теряется при получении урона (возвращается в Арсенал)

#### MineDetector (Миноискатель)
- **Эффект:** защищает от урона Мин **бесконечно**
- **Механика:** при входе на клетку с Миной урон не наносится
- **Потеря:** теряется при получении урона **от других источников** (возвращается в Арсенал)

#### Cement (Цемент)
- **Эффект:** позволяет использовать действие BUILD
- **Механика:** одноразовый — после строительства стены **возвращается в Арсенал**
- **Тактика:** можно строить стены для блокировки монстров, затем взять Cement снова

### 4.3 Правила арсенальных предметов

1. **Выбор:** предметы берутся только в здании Арсенала через UI-кнопки
2. **Лимит:** игрок может нести количество предметов равное `max_arsenal_items` (по умолчанию 1, увеличивается сумками Bag)
3. **Потеря при уроне:** при получении урона (если нет брони) **все арсенальные предметы** выпадают и возвращаются в Арсенал
4. **Возврат предметов:** все предметы, вернувшиеся в Арсенал (после потери или использования), **снова доступны для взятия**
5. **Исключение:** Золото **никогда не теряется**
6. **Несколько одинаковых предметов:** если в Арсенале есть несколько экземпляров одного предмета и у игрока есть свободные слоты, можно взять несколько одинаковых предметов (например, 2 Armor)

---

## 5. Здания

### 5.1 Arsenal (Арсенал)

**Количество:** 1 на лабиринт

**Эффекты при входе:**
- Полное восстановление стрел (до максимума)
- Полное восстановление бомб (до максимума)
- Доступ к выбору предметов через кнопки интерфейса

**Предметы в Арсенале:**
- DoubleGun
- Armor
- MineDetector
- Cement

### 5.2 Hospital (Госпиталь)

**Количество:** 1 на лабиринт

**Эффект при входе:**
- Полное восстановление здоровья (до максимума)

### 5.3 Portal (Портал)

**Количество:** 5 (по умолчанию)

**Механика:**
- Порталы образуют **кольцевую цепочку**: Portal 1 → Portal 2 → Portal 3 → Portal 4 → Portal 5 → Portal 1
- При входе игрок **мгновенно телепортируется** к следующему порталу в цепи
- Порталы распределены **случайно между всеми этажами** — телепортация может переносить между этажами

### 5.4 Mines (Мины)

**Количество:** 1 на лабиринт

**Эффект при входе:**
- Наносит **1 урон** игроку
- **Защита:** если есть MineDetector — урон не наносится

**Особенность:** мины срабатывают **каждый раз** при входе на клетку.

**Телепортация на мину:** если игрок телепортируется на клетку с миной (через портал), мина срабатывает в конце хода. Однако если игрок телепортируется **с** клетки с миной — он не получает урона (мина на исходной клетке не срабатывает).

### 5.5 Lift (Лифт)

**Количество:** 1 шахта на лабиринт (только при floors > 1)

**Механика:**
- Лифт создаётся **только если в лабиринте несколько этажей**
- Лифт занимает **одну вертикальную шахту** (одни и те же координаты X,Y на всех этажах)
- При входе появляются кнопки выбора этажа
- Перемещение между этажами **мгновенное**
- Координаты X,Y сохраняются, меняется только этаж Z

### 5.6 Graveyard (Кладбище)

**Количество:** 1 на лабиринт

**Эффект:** нет (безопасная зона)

**Назначение:** точка возрождения после смерти

---

## 6. Монстры

### 6.1 Общие правила

- Все монстры принадлежат фракции `monster`
- Монстры атакуют **автоматически** в конце каждого хода игрока
- Монстры **не атакуют друг друга**
- У всех монстров есть здоровье (HP)
- Монстры погибают при HP ≤ 0 и могут оставлять предметы

### 6.2 Dragon (Дракон)

**Количество:** 2 (по умолчанию)
**Здоровье:** 5 HP

**Атака — Огненное дыхание:**
- Направление: **все 4 стороны одновременно** (вверх, вправо, вниз, влево) **+ своя клетка**
- Дальность: **1 клетка** (смежные клетки и клетка дракона)
- Урон: **1 HP** за каждое попадание

**Встреча с драконом:**
- При входе на клетку дракона игрок получает **1 урон** от огненного дыхания (дракон атакует свою клетку)
- Далее дракон продолжает атаковать каждый ход

**Добыча с убийства:** DragonRing (+1 макс. здоровье, +1 текущее здоровье)

### 6.3 Archer (Лучник)

**Количество:** настраивается параметром `archer_count`
**Здоровье:** 5 HP (настраивается параметром `archer_health`)

**Атака — Выстрел:**
- Направление: **фиксированное** (одно из четырёх, определяется при создании)
- Дальность: **неограниченная** (стрела летит до стены или цели)
- Урон: **1 HP**

**Поведение:**
- Каждый ход стреляет в своём фиксированном направлении
- Стрелы не проходят сквозь стены
- Игрок узнаёт направление стрельбы лучника, когда встаёт с ним на одну клетку

**Добыча с убийства:** Bag (+1 слот инвентаря)

---

## 7. Система урона и защиты

### 7.1 Источники урона

| Источник | Урон | Защита |
|----------|------|--------|
| Огонь дракона | 1 HP | Armor |
| Стрела лучника | 1 HP | Armor |
| Мины | 1 HP | MineDetector или Armor |

**Множественный урон:** если игрок находится в зоне атаки нескольких монстров, он получает урон от каждого отдельно. Armor блокирует только **один** источник урона, после чего разрушается — остальные попадания наносят урон напрямую.

### 7.2 Обработка урона

**Порядок проверок для каждого источника урона:**

1. **Урон от Мин — есть MineDetector?**
   - Да → урон полностью блокируется, MineDetector **не расходуется** (защищает бесконечно)
   - Нет → переход к п.2

2. **Есть Armor?**
   - Да → урон поглощается, Armor разрушается и возвращается в Арсенал
   - Нет → переход к п.3

3. **Применение урона:**
   - Здоровье уменьшается на величину урона
   - **Все арсенальные предметы выпадают** и возвращаются в Арсенал
   - Золото **не теряется**

4. **Проверка смерти:**
   - Если здоровье ≤ 0 → смерть и возрождение

**Важно:** При получении урона (если нет защиты) арсенальные предметы теряются **сразу**. Если в одном ходе игрок получает урон от нескольких источников, предметы теряются после первого незащищённого попадания.

### 7.3 Смерть и возрождение

**При смерти:**
1. Игрок телепортируется на **Кладбище**
2. Здоровье восстанавливается до `max_health - 1` (минимум 1)
3. Все предметы **остаются в инвентаре** (включая Золото)
4. Игра продолжается

**Важно:** Проигрыша не существует — игрок **всегда возрождается** и может продолжать игру бесконечно.

---

## 8. Структура хода

### 8.1 Фазы хода

```
1. Фаза действия игрока
   └── Выбор действия (GO / SHOOT / BOMB / BUILD)
   └── Выполнение действия

2. Фаза свойств клетки
   └── Срабатывание зданий (Мины, Арсенал, Госпиталь, Портал, Лифт)
   └── Подбор предметов (Золото, Сумки, Кольцо Дракона)

3. Фаза монстров (End Turn)
   └── Все драконы атакуют (огонь в 4 стороны + своя клетка)
   └── Все лучники атакуют (стрела в фиксированном направлении)

4. Начало нового хода
```

### 8.2 Особенности

- Каждое действие (кроме отмены) **завершает ход** и вызывает атаку монстров
- Пропустить ход **нельзя**
- Все монстры атакуют **одновременно** в конце хода

---

## 9. Условия победы и поражения

### 9.1 Победа

**Условие:** войти на клетку с Выходом, имея в инвентаре Золото.

**Результат:**
- Выводится сообщение "Победа!"
- Игра завершается (`game.ended = True`)

### 9.2 Поражение

**Условие:** отсутствует.

Игрок **не может проиграть**. При смерти происходит возрождение на Кладбище, и игра продолжается. Теоретически возможен **софт-лок** (если Золото становится недоступным), но это не является официальным поражением.

---

## 10. Сохранение и продолжение

### 10.1 Автосохранение

- Состояние игры сохраняется в **Firebase Realtime Database** после каждого действия
- Сохраняется полная информация: лабиринт, игрок, монстры, предметы, здания

### 10.2 Продолжение игры

- Команда для новой игры: `/new_game`
- При выходе из бота и возвращении — игра продолжается с того же места
- Нельзя иметь несколько активных игр одновременно

---

## 11. Параметры по умолчанию

### 11.1 Игрок

| Параметр | Значение |
|----------|----------|
| Здоровье | 5 |
| Стрелы | 5 |
| Бомбы | 2 |
| Слоты арсенала | 1 |

### 11.2 Мир

| Объект | Количество |
|--------|------------|
| Драконы | 2 (5 HP каждый) |
| Порталы | 5 |
| Мины | 1 |
| Арсеналы | 1 |
| Госпитали | 1 |
| Кладбища | 1 |
| Лифты | 1 |

---

## 12. Настраиваемые параметры

| Параметр | Описание | Диапазон | По умолчанию |
|----------|----------|----------|--------------|
| `seed` | Seed для генератора случайных чисел | Число / null | null |
| `width` | Ширина лабиринта | 3–8 | Случайно |
| `height` | Высота лабиринта | 3–8 | Случайно |
| `floors` | Количество этажей | 1–3 | Случайно |
| `player_health` | Начальное/макс. здоровье игрока | 1+ | 5 |
| `player_arrows` | Начальное количество стрел | 0+ | 5 |
| `player_bombs` | Начальное количество бомб | 0+ | 2 |
| `arsenal_slots` | Начальное количество слотов инвентаря | 1+ | 1 |
| `dragon_count` | Количество драконов | 0+ | 2 |
| `dragon_health` | Здоровье каждого дракона | 1+ | 5 |
| `dragon_damage` | Урон огня дракона | 1+ | 1 |
| `archer_count` | Количество лучников | 0+ | 0 |
| `archer_health` | Здоровье каждого лучника | 1+ | 5 |
| `archer_damage` | Урон стрелы лучника | 1+ | 1 |
| `portal_count` | Количество порталов | 0+ | 5 |
| `mine_count` | Количество мин | 0+ | 1 |
| `mine_damage` | Урон от мины | 1+ | 1 |
| `hospital_count` | Количество госпиталей | 0+ | 1 |
| `arsenal_count` | Количество арсеналов | 0+ | 1 |
| `death_limit` | Лимит смертей (0 = бесконечно) | 0+ | 0 |
| `respawn_health_percent` | Процент HP при возрождении | 1–100 | 80 |
| `arrow_damage` | Базовый урон стрелы игрока | 1+ | 1 |
| `doublegun_multiplier` | Множитель урона DoubleGun | 1+ | 2 |
| `dragon_ring_health_bonus` | Бонус HP от DragonRing | 0+ | 1 |
| `bag_slot_bonus` | Бонус слотов от Bag | 0+ | 1 |
| `spawn_location` | Стартовая позиция игрока | `graveyard` / `random` | `graveyard` |

### Описание ключевых параметров

**seed** — фиксирует генерацию лабиринта. Одинаковый seed = одинаковый лабиринт. Полезно для соревнований и ежедневных челленджей.

**death_limit** — количество смертей до поражения. При значении 0 игрок возрождается бесконечно. При значении 1 — хардкор-режим.

**respawn_health_percent** — процент от максимального HP при возрождении. Формула: `HP = max_health * percent / 100` (минимум 1).

**doublegun_multiplier** — во сколько раз увеличивается урон стрелы с DoubleGun (по умолчанию x2)

**spawn_location** — где игрок появляется в начале игры:
- `graveyard` — на Кладбище (по умолчанию)
- `random` — на случайной клетке лабиринта

---

## 13. Видимость и информация

### 13.1 Туман войны

Игрок **не видит карту лабиринта**. Он ходит вслепую и получает информацию только о:
- Своей текущей клетке (здание, предметы, монстры)
- Направлениях, куда можно идти (стены/проходы)
- Результатах своих действий

**Карта не отображается** — игрок может самостоятельно рисовать карту на бумаге на основе полученной информации.

### 13.2 Обнаружение монстров

- **Дракон:** игрок узнаёт о драконе, когда входит на его клетку или получает урон от огненного дыхания
- **Лучник:** игрок узнаёт о лучнике, когда входит на его клетку. Направление стрельбы также становится известно при нахождении на одной клетке

---

## 14. Дополнительные механики

### 14.1 Телепортация

| Тип | Изменение позиции |
|-----|-------------------|
| Портал | Перемещение к следующему порталу в цепи (может быть на другом этаже) |
| Лифт | Смена этажа (те же X,Y) |
| Смерть | Телепортация на Кладбище |

Все виды телепортации **мгновенны** и не триггерят эффекты промежуточных клеток.

### 14.2 Взаимодействие стрел с препятствиями

```
Стрела летит →
├── Пустая клетка → продолжает лететь
├── Клетка с монстром → наносит урон, исчезает
├── Клетка с порталом → продолжает лететь (стрелы НЕ телепортируются)
└── Стена → останавливается, исчезает
```

**Важно:** стрелы (как игрока, так и лучников) летят по прямой и **игнорируют свойства клеток** — порталы на них не действуют.

### 14.3 Модификаторы урона

| Предмет | Эффект |
|---------|--------|
| DoubleGun | Урон стрел: 1 → 2 |
| DragonRing | Макс. здоровье: +1 за каждое кольцо |

---

## 15. Краткая памятка

1. **Цель:** найти Золото и дойти до Выхода
2. **Ресурсы:** стрелы, бомбы, здоровье — восстанавливаются в Арсенале/Госпитале
3. **Монстры:** драконы (огонь во все стороны) и лучники (стреляют в одном направлении)
4. **Защита:** Armor блокирует урон, MineDetector защищает от мин
5. **Смерть:** возрождение на Кладбище, предметы сохраняются
6. **Победа:** Золото + Выход
7. **Поражение:** невозможно (бесконечные жизни)
